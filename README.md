# Claude Dev Insights

[![tests](https://github.com/kanopi/claude-dev-insights/actions/workflows/test.yml/badge.svg?branch=main)](https://github.com/kanopi/claude-dev-insights/actions/workflows/test.yml?query=branch%3Amain)
[![last commit](https://img.shields.io/github/last-commit/kanopi/claude-dev-insights)](https://github.com/kanopi/claude-dev-insights/commits)
[![release](https://img.shields.io/github/v/release/kanopi/claude-dev-insights)](https://github.com/kanopi/claude-dev-insights/releases/latest)
![project is maintained](https://img.shields.io/maintenance/yes/2025.svg)
[![Documentation](https://img.shields.io/badge/docs-zensical-blue.svg)](https://kanopi.github.io/claude-dev-insights/)
[![License](https://img.shields.io/badge/license-GPL--2.0--or--later-blue.svg)](LICENSE.md)

**Developer analytics and productivity insights for Claude Code.** Automatically track sessions, enforce security policies, guard against cost overruns, and ensure code quality with 4 intelligent hooks.

---

## Features

### üìä Session Analytics (SessionStart + SessionEnd)
- **28 data points per session** - Duration, messages, tokens, costs, tool usage
- **Local CSV storage** - `~/.claude/session-logs/sessions.csv`
- **Google Sheets sync** - Optional cloud backup for team sharing
- **Environment profiling** - CMS detection, dependency tracking, git status

### üîí Security Scanner (PreToolUse)
- **Block sensitive file access** - `.env`, `*.key`, credentials, secrets
- **Dangerous command detection** - `rm -rf`, `chmod 777`, `sudo rm`
- **Real-time alerts** - Console warnings before risky operations
- **Security event logging** - Audit trail of blocked operations

### üí∞ Cost Guard (PreToolUse)
- **Session budget tracking** - Configurable spending limits
- **Expensive tool warnings** - WebSearch, WebFetch, Task operations
- **Real-time cost alerts** - Stop before exceeding budget
- **Token usage monitoring** - Track cumulative costs per session

### ‚úÖ Quality Automator (PostToolUse)
- **Auto-run linters** - PHPCS, ESLint, Stylelint, Flake8 after edits
- **Commit message validation** - Conventional commits enforcement
- **Code quality logging** - Track violations and improvements
- **Configurable rules** - Customize quality standards

---

## Quick Install

**Via Claude Toolbox Marketplace:**

```bash
# Inside Claude Code CLI
/plugin marketplace add kanopi/claude-toolbox
/plugin install claude-dev-insights@claude-toolbox
```

**Direct Install:**

```bash
# Inside Claude Code CLI
/plugin install https://github.com/kanopi/claude-dev-insights
```

That's it! Hooks activate automatically when the plugin is enabled.

---

## Quick Start: Ticket Tracking

Track which tickets/issues you work on in each session:

**Automatic (easiest):** Just mention the ticket in your first message:
```
Working on JIRA-1234 - fixing the login bug
```

**Manual:** Use the `ticket:` command in your message:
```
ticket: JIRA-1234          # Set one ticket
ticket: JIRA-1234 GH-567   # Set multiple tickets
ticket: JIRA-9999          # Add another ticket later
```

All tickets are logged to the CSV for easy reporting:
```bash
grep JIRA-1234 ~/.claude/session-logs/sessions.csv
```

---

## What Gets Tracked

### Session CSV Columns (28 fields)

| Column | Description | Example |
|--------|-------------|---------|
| `timestamp` | Session end timestamp | `2025-11-12 08:45:23` |
| `session_id` | Unique session identifier | `abc123def456` |
| `user` | Git user name or system username | `John Doe` |
| `ticket_number` | Optional ticket/issue number | `JIRA-1234` |
| `project` | Project directory name | `my-project` |
| `summary` | One-line session description | `Feature: User Auth` |
| `cms_type` | Detected CMS (drupal/wordpress/unknown) | `drupal` |
| `environment_type` | Environment (ddev/local) | `ddev` |
| `dependencies_count` | Number of composer dependencies | `47` |
| `uncommitted_changes` | Number of uncommitted files at start | `3` |
| `source` | Session source (new/resume) | `new` |
| `end_reason` | How session ended (clear/crash/etc) | `clear` |
| `duration_seconds` | Session duration in seconds | `1847` |
| `user_messages` | Number of user messages | `45` |
| `assistant_messages` | Number of assistant messages | `62` |
| `input_tokens` | Tokens sent to API | `18943` |
| `output_tokens` | Tokens generated by API | `12561` |
| `cache_read_tokens` | Tokens read from cache | `2841023` |
| `cache_write_tokens` | Tokens written to cache | `198234` |
| `total_tokens` | Sum of all token types | `3070761` |
| `total_cost` | Session cost in USD | `2.1847` |
| `tool_calls` | Number of tool invocations | `38` |
| `api_time_seconds` | Total API time in seconds | `47` |
| `avg_call_time_ms` | Average API call time in ms | `1237` |
| `tools_used` | Top 5 tools with counts | `Bash:12; Read:10; Edit:8` |
| `git_branch` | Active git branch | `main` |
| `claude_version` | Claude Code version | `2.0.36` |
| `permission_mode` | Permission mode setting | `default` |

---

## Configuration

All hooks are configurable via JSON files in `config/`:

### Security Patterns (`config/security-patterns.json`)

```json
{
  "blocked_files": [".env", "*.key", "credentials.json"],
  "sensitive_files": ["wp-config.php", "settings.php"],
  "dangerous_commands": ["rm -rf /", "chmod 777", "sudo rm"]
}
```

### Cost Thresholds (`config/cost-thresholds.json`)

```json
{
  "session_budget": 5.00,
  "warn_at_percent": 80,
  "expensive_tools": ["WebSearch", "WebFetch", "Task"]
}
```

### Quality Rules (`config/quality-rules.json`)

```json
{
  "auto_lint": {
    "enabled": true,
    "php_files": ["phpcs", "--standard=PSR12"],
    "js_files": ["eslint"]
  },
  "commit_message": {
    "enabled": true,
    "require_type": true,
    "min_length": 10,
    "types": ["feat", "fix", "docs", "style", "refactor", "test", "chore"]
  }
}
```

**Configuration location:**
- Plugin users: `~/.claude/plugins/cache/claude-dev-insights/config/`
- Project install: `$CLAUDE_PROJECT_DIR/.claude/dev-insights/config/`

---

## Hook Feedback

The PreToolUse and PostToolUse hooks can provide feedback when they block operations or detect issues:

### Security Block
```
üîí BLOCKED: Access to sensitive file '.env'
   This file matches a security pattern and cannot be accessed.
   If this is a false positive, update: config/security-patterns.json
```

### Cost Warning
```
üí∞ COST WARNING: Session approaching budget limit
   Tool: WebSearch (expensive operation)
   Check your usage with: cat ~/.claude/session-logs/sessions.csv
```

### Quality Violation
```
‚ö†Ô∏è  Code Quality Warning: src/api.php
   Linter: phpcs

   FILE: /path/to/src/api.php
   Line 42: Missing function docblock
   Line 58: Variable $data is undefined

   ... (output truncated, see full results with: phpcs src/api.php)
```

**Note:** SessionStart and SessionEnd hooks log data in the background. Check `~/.claude/session-logs/sessions.csv` to view your session history.

---

## Google Sheets Integration

### Why Use Google Sheets?

- ‚òÅÔ∏è **Cloud backup** - Your data is safe in the cloud
- üë• **Team sharing** - Share insights with your team
- üìä **Easy visualization** - Built-in charts and pivot tables
- üì± **Access anywhere** - View on any device
- üîÑ **Real-time sync** - Data updates automatically

### Quick Setup

1. **Install Python dependencies:**
   ```bash
   pip3 install gspread oauth2client
   ```

2. **Run interactive setup:**
   ```bash
   python3 ~/.claude/plugins/cache/claude-dev-insights/hooks/session-end/sync-to-google-sheets.py --setup
   ```

3. **Test connection:**
   ```bash
   python3 ~/.claude/plugins/cache/claude-dev-insights/hooks/session-end/sync-to-google-sheets.py --test
   ```

**Full setup guide:** [docs/google-sheets/setup.md](https://kanopi.github.io/claude-dev-insights/google-sheets/setup)

---

## Usage Examples

### View Your Analytics

```bash
# View all sessions
cat ~/.claude/session-logs/sessions.csv

# Calculate total cost
awk -F, 'NR>1 {sum+=$14} END {print "Total: $"sum}' ~/.claude/session-logs/sessions.csv

# Cost by project
awk -F, 'NR>1 {cost[$3]+=$14} END {for(p in cost) print p": $"cost[p]}' ~/.claude/session-logs/sessions.csv

# Generate full report
python3 ~/.claude/plugins/cache/claude-dev-insights/lib/analytics.py markdown
```

### View Security Events

```bash
# All security events
cat ~/.claude/session-logs/security.log

# Today's events
grep "$(date '+%Y-%m-%d')" ~/.claude/session-logs/security.log

# Blocked operations
grep "BLOCKED" ~/.claude/session-logs/security.log
```

### View Quality Events

```bash
# All quality events
cat ~/.claude/session-logs/quality.log

# Failed lints
grep "LINT_FAIL" ~/.claude/session-logs/quality.log

# Invalid commits
grep "COMMIT_INVALID" ~/.claude/session-logs/quality.log
```

---

## Disabling Features

### Disable Specific Hooks

Edit `hooks/hooks.json` and remove unwanted hooks, or set them to empty arrays:

```json
{
  "hooks": {
    "PreToolUse": [],
    "PostToolUse": []
  }
}
```

### Disable Google Sheets Sync

```bash
python3 ~/.claude/plugins/cache/claude-dev-insights/hooks/session-end/sync-to-google-sheets.py --disable
```

### Disable Plugin Entirely

```bash
claude plugins disable claude-dev-insights
```

---

## Privacy & Security

### What's Logged

- ‚úÖ Session metadata (timestamps, IDs, duration)
- ‚úÖ Usage statistics (tokens, costs, tool counts)
- ‚úÖ Session summary (one-line description)
- ‚úÖ Security events (blocked operations)
- ‚úÖ Quality events (linter results)
- ‚ùå **Not logged:** Actual code, conversation content, sensitive data

### Data Location

- **Local CSV**: `~/.claude/session-logs/sessions.csv` (your machine only)
- **Local logs**: `~/.claude/session-logs/security.log`, `quality.log`
- **Google Sheets**: Only if you explicitly configure it

### Security Best Practices

If using Google Sheets:

1. **Protect credentials** - Keep service account keys private
2. **Set permissions** - Only share sheets with trusted team members
3. **Use dedicated account** - Create service account specifically for this
4. **Rotate keys** - Regularly update service account keys

---

## Requirements

### Required
- **Claude Code CLI** - To run the plugin
- **jq** - JSON parsing (usually pre-installed on macOS/Linux)
  - macOS: `brew install jq`
  - Linux: `apt-get install jq`

### Optional
- **Python 3** - For Google Sheets sync and analytics reports
- **gspread, oauth2client** - `pip3 install gspread oauth2client`
- **Linters** - PHPCS, ESLint, Stylelint, Flake8 (for quality automation)

---

## License

GPL-2.0-or-later - see [LICENSE.md](LICENSE.md) file for details.

---

## Documentation

Full documentation is available at [https://kanopi.github.io/claude-dev-insights/](https://kanopi.github.io/claude-dev-insights/)

## Support

- **Issues**: [GitHub Issues](https://github.com/kanopi/claude-dev-insights/issues)
- **Source Code**: [GitHub Repository](https://github.com/kanopi/claude-dev-insights)

---

**Created and maintained by [Kanopi Studios](https://kanopi.com)**
